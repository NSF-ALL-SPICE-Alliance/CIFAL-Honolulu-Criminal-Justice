---
title: "Vulnerability Index - Organized Crime"
author: "Andrew Nishitomi & Connor Flynn"
date: "2/1/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(janitor)
library(ggcorrplot)
library(gridExtra)
```

Uploading csv file and naming it "oc_index"
```{r}
oc_index <- read_csv(here("data/global_oc_index_2021_sids_category.csv"))
```

clean the data
```{r}
oc_index <- oc_index %>% 
  clean_names()
```

Creating new data frame, but adding criminality_mean_score column
```{r}
oc_index_overall_score <- oc_index %>% 
  mutate(criminality_mean_score = rowMeans(across(c(criminality, criminal_markets, human_trafficking, human_smuggling, 
                                                  arms_trafficking, flora_crimes, fauna_crimes, non_renewable_resource_crimes,
                                                  heroin_trade, cocaine_trade, cannabis_trade, synthetic_drug_trade, criminal_actors,
                                                  mafia_style_groups, criminal_networks, state_embedded_actors, foreign_actors))))
```

Using same data frame. Adding resillience_mean_score column
```{r}
oc_index_overall_score <- oc_index_overall_score %>% 
  mutate(resillience_mean_score = rowMeans(across(c(political_leadership_and_governance, government_transparency_and_accountability,international_cooperation, national_policies_and_laws, judicial_system_and_detention, law_enforcement, territorial_integrity, anti_money_laundering, economic_regulatory_capacity, victim_and_witness_support, prevention, non_state_actors))))
```

Using two new columns to create a new column overall_score
```{r}
oc_index_overall_score <- oc_index_overall_score %>% 
  mutate(overall_score = resillience_mean_score - criminality_mean_score)
```



Histogram
Renaming data frame oc_index to oc_index_longer to set up in creating a Histogram
```{r}
oc_index_longer <- oc_index %>% 
  pivot_longer(cols = criminality:non_state_actors, 
               names_to = "ranking", 
               values_to = "value")
```


Creation of the Histogram based on sids and non sids based on value
```{r}
ggplot(data = oc_index_longer, aes(x = value)) +
  geom_histogram() +
  theme_minimal() +
  facet_grid(~sids_category)
```
Creating multiple hisograms based on region
```{r}
ggplot(data = oc_index_longer, aes(x = value, fill = sids_category)) +
  geom_histogram() +
  theme_minimal() +
  facet_wrap(~region)
```



Optional - Make a new column in oc_index_longer that indicates whether a ranking is a criminality score (low is good?) or a resillience score (high is good)



Heatmap 
Renaming Oc_index to oc_index_sids and filtering for sids
```{r}
oc_index_sids <- oc_index %>% 
  filter(sids_category == "sids")
```

Removing columns "continent, region, country_code, sids_category
```{r}
oc_index_sids <- oc_index_sids %>% 
  select(-continent, -region, -country_code, -sids_category) 
```

Creating a new data frame
```{r}
oc_index_sids_longer <- oc_index_sids %>% 
  pivot_longer(cols = criminality:non_state_actors,
               names_to = "measure",
               values_to = "value")

```





```{r}
#oc_index_sids_matrix <- as.matrix(oc_index_sids_longer)
```




Creation of Heatmap
```{r}
ggplot(data = oc_index_sids_longer, aes(x = measure,
                                        y = country,
                                        fill = value)) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 45, size = 6, vjust = 1, hjust = 1)) +
   scale_fill_gradient(low = "yellow", high = "red")
```




Correlation Matrix 
REnaming oc_index_sids to oc_index_sids_corr and removing country
```{r}
oc_index_sids_corr <- oc_index_sids %>% 
  select(-country)
```

Calling new data frame corr
```{r}
corr <- oc_index_sids_corr %>% 
  cor()
```

making correlation Matrix with sids only
```{r}
sids_corrplot <- ggcorrplot(corr, hc.order = TRUE, type = "lower") +
  theme(axis.text.x = element_text(angle = 45, size = 6, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 6, vjust = 1, hjust = 1))
sids_corrplot
```

Andrew: Can you make this correlation plot for all countries in the oc index (eactly what we did above but for all countries instead of just sids)

Renaming oc_index to oc_index_corr and removing country, sids_category, country_code, region, continent.
```{r}
oc_index_corr <- oc_index %>% 
  select(-continent, -region, -country_code, -sids_category, -country) 
```

Calling new data frame corr_all
```{r}
corr_all <- oc_index_corr %>% 
  cor()
```


Making Correlation Matrix with all countries
```{r}
all_corrplot <- ggcorrplot(corr_all, hc.order = TRUE, type = "lower") +
  theme(axis.text.x = element_text(angle = 45, size = 6, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 6, vjust = 1, hjust = 1))
all_corrplot
```
Placing both correlation graphs onto one plot
```{r}
grid.arrange(sids_corrplot, all_corrplot, ncol=2)
```


```{r}
# Create two example matrices
mat1 <- matrix(1:9, nrow = 3, ncol = 3)
mat2 <- matrix(9:1, nrow = 3, ncol = 3)

# Subtract one matrix from the other
diff_mat <- mat1 - mat2

# Print the resulting matrix
diff_mat
```


```{r}
matrix_comparison <- corr_all - corr
```


```{r}
# Create the heatmap
heatmap(matrix_comparison, col = colorRampPalette(c("blue", "white", "red"))(100), 
        main = "Matrix Difference Heatmap")

# Add color bar
colorbar <- seq(min(matrix_comparison), max(matrix_comparison), length.out = 100)
image(1, seq_along(colorbar), t(matrix(colorbar, ncol = 1)),
      col = colorRampPalette(c("blue", "white", "red"))(100), 
      xlab = "", ylab = "", yaxt = "n")
axis(4, at = pretty(range(diff_mat)), las = 2)
mtext("Difference", side = 4, line = 3)

```

```{r}


# Convert the difference matrix to a data frame
diff_df <- as.data.frame(matrix_comparison)
diff_df$row <- rownames(diff_df)

# Reshape the data into long format
diff_long <- tidyr::gather(diff_df, column, value, -row)

# Create the heatmap using ggplot2
ggplot(diff_long, aes(x = column, y = row, fill = value)) + 
  geom_tile() +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0, 
                       na.value = "grey50", guide = "colorbar") +
  labs(title = "Matrix Difference Heatmap", x = "", y = "Rows", fill = "Difference")



```

